<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - MetalForge</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="dark">
  <header>
    <div class="logo">
      <img src="logo-placeholder.png" alt="Logo" />
      MetalForge Admin
    </div>
    <button class="toggle-mode" onclick="toggleMode()">Toggle Mode</button>
  </header>

  <button class="logout" onclick="logout()" style="display:none;">Logout</button>

  <div class="container" id="loginSection">
    <h2>Admin Login</h2>
    <input type="text" id="username" placeholder="Username" />
    <input type="password" id="password" placeholder="Password" />
    <button onclick="login()">Login</button>
  </div>

  <div class="container" id="adminContent" style="display:none;">
    <h2>Upload Section</h2>
    <div id="sectionsContainer"></div>
  </div>

<script>
  // --- CONFIGURATION ---
  // Replace these values with your own.
  const GITHUB_PAT = "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"; // Paste the token you just generated
  const GITHUB_USER = "tb-1022"; // Your GitHub username
  const GITHUB_REPO = "metal-processing-site"; // Your GitHub repository name
  const UPLOAD_PATH = "assets/images"; // The folder in your repo to store files
  // ---------------------

  const sections = ["cutting", "welding", "polishing", "coating"];

  // Helper function to convert file to Base64 for the API
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result.split(',')[1]); // Get only the Base64 part
      reader.onerror = error => reject(error);
    });
  }

  async function saveSection(section) {
    // Save text (this part remains the same)
    const textVal = document.getElementById(section + "Text").value.trim();
    if (textVal) {
      const texts = JSON.parse(localStorage.getItem(section + "Texts") || "[]");
      texts.push(textVal);
      localStorage.setItem(section + "Texts", JSON.stringify(texts));
      document.getElementById(section + "Text").value = "";
    }

    // --- NEW: UPLOAD FILE TO GITHUB ---
    const files = document.getElementById(section + "File").files;
    if (files.length === 0) {
      alert("No file selected for upload.");
      return; // Stop if no file is chosen
    }

    const file = files[0];
    const fileName = `${Date.now()}-${file.name}`; // Create a unique filename
    const apiUrl = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${UPLOAD_PATH}/${fileName}`;

    alert("Starting file upload to GitHub. This may take a moment...");

    try {
      const content = await fileToBase64(file); // Convert file to Base64

      const response = await fetch(apiUrl, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${GITHUB_PAT}`,
          'Accept': 'application/vnd.github.v3+json'
        },
        body: JSON.stringify({
          message: `feat: upload ${fileName}`, // Commit message
          content: content
        })
      });

      const result = await response.json();

      if (!response.ok) {
        // If API returned an error
        throw new Error(`GitHub API Error: ${result.message}`);
      }
      
      const fileUrl = result.content.download_url; // The direct URL to the file

      // Save the public URL to localStorage
      const media = JSON.parse(localStorage.getItem(section + "Media") || "[]");
      media.push({
        type: file.type,
        src: fileUrl
      });
      localStorage.setItem(section + "Media", JSON.stringify(media));

      alert("File uploaded successfully!");
      renderPreview(section);

    } catch (error) {
      console.error(error);
      alert(`Upload failed: ${error.message}`);
    }
  }
  
  // No changes needed for the functions below this line
  // They are included so you can replace the whole script block

  function login() {
    const user = document.getElementById("username").value;
    const pass = document.getElementById("password").value;
    if (user === "admin" && pass === "1234") {
      localStorage.setItem("isAdmin", "true");
      document.getElementById("loginSection").style.display = "none";
      document.getElementById("adminContent").style.display = "block";
      document.querySelector(".logout").style.display = "block";
      renderSections();
    } else {
      alert("Incorrect credentials!");
    }
  }

  function logout() {
    localStorage.removeItem("isAdmin");
    window.location.href = "index.html";
  }

  function renderSections() {
    const container = document.getElementById("sectionsContainer");
    container.innerHTML = "";
    sections.forEach(section => {
      const div = document.createElement("div");
      div.className = "section";
      div.innerHTML = `
        <h3>${section.toUpperCase()}</h3>
        <textarea id="${section}Text" placeholder="Enter description..."></textarea>
        <input type="file" id="${section}File" />
        <button onclick="saveSection('${section}')">Save ${section}</button>
        <div class="preview" id="${section}Preview"></div>
      `;
      container.appendChild(div);
      renderPreview(section);
    });
  }

  function renderPreview(section) {
    const container = document.getElementById(section + "Preview");
    container.innerHTML = "";
    const media = JSON.parse(localStorage.getItem(section + "Media") || "[]");
    media.forEach(item => {
      if (item.type.startsWith("image")) {
        const img = document.createElement("img");
        img.src = item.src;
        container.appendChild(img);
      } else if (item.type.startsWith("video")) {
        const video = document.createElement("video");
        video.src = item.src;
        video.controls = true;
        container.appendChild(video);
      }
    });
  }

  function toggleMode() {
    document.body.classList.toggle("light");
  }

  window.onload = () => {
    if (localStorage.getItem("isAdmin") === "true") {
      document.getElementById("loginSection").style.display = "none";
      document.getElementById("adminContent").style.display = "block";
      document.querySelector(".logout").style.display = "block";
      renderSections();
    }
  };
</script>

  </body>
</html>
